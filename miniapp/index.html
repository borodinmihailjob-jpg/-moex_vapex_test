<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>MOEX Portfolio Mini App</title>
  <link rel="stylesheet" href="/miniapp/styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="app" class="app-shell">
    <header class="app-header">
      <div>
        <h1>MOEX Portfolio</h1>
        <p id="userLine">Загрузка…</p>
      </div>
      <div class="header-actions">
        <button id="switchModeBtn" class="btn ghost">Режим</button>
        <button id="refreshBtn" class="btn ghost">Обновить</button>
      </div>
    </header>

    <main id="content" class="content">
      <section id="tab-mode" class="tab-view active">
        <article class="card">
          <h2>Выберите режим</h2>
          <p class="hint">Бот умеет и в биржу, и в личный бюджет. Можно переключаться в любой момент.</p>
          <div class="mode-grid">
            <div class="mode-card">
              <h3>Биржа</h3>
              <p class="hint">Портфель, сделки, котировки и отчёты</p>
              <button id="openExchangeBtn" class="btn primary">Открыть биржу</button>
            </div>
            <div class="mode-card">
              <h3>Бюджет</h3>
              <p class="hint">План на месяц, цели и “крупные траты”</p>
              <button id="openBudgetBtn" class="btn primary">Открыть бюджет</button>
            </div>
          </div>
          <p id="lastModeLine" class="hint"></p>
          <button id="openLastModeBtn" class="btn ghost" style="display:none">Открыть как в прошлый раз</button>
        </article>
      </section>

      <section id="tab-dashboard" class="tab-view">
        <article class="card summary-card">
          <h2>Портфель</h2>
          <div class="summary-grid">
            <div>
              <span class="label">Стоимость</span>
              <strong id="totalValue">—</strong>
            </div>
            <div>
              <span class="label">P&amp;L</span>
              <strong id="totalPnl">—</strong>
            </div>
          </div>
        </article>
        <article class="card">
          <h2>Позиции</h2>
          <div id="positions" class="list"></div>
        </article>
      </section>

      <section id="tab-trade" class="tab-view">
        <article class="card">
          <h2>Добавить сделку</h2>
          <div class="form-grid two">
            <label>Операция
              <select id="tradeSide">
                <option value="buy">Покупка</option>
                <option value="sell">Продажа</option>
              </select>
            </label>
            <label>Тип актива
              <select id="tradeAssetType">
                <option value="stock">Акции</option>
                <option value="metal">Металлы</option>
                <option value="fiat">Фиат</option>
              </select>
            </label>
          </div>
          <div class="form-grid two">
            <label>Дата сделки
              <input id="tradeDate" type="text" placeholder="dd.mm.yyyy" />
            </label>
            <label>Поиск инструмента
              <div class="search-control">
                <button id="tradeSearchClear" class="search-clear" type="button" aria-label="Очистить поиск">×</button>
                <input id="tradeSearch" type="text" placeholder="SBER / GLDRUB_TOM / доллар" />
              </div>
            </label>
          </div>
          <div id="tradeSearchResults" class="list compact"></div>
          <p id="tradeSelected" class="hint">Инструмент не выбран</p>
          <div class="form-grid three">
            <label>Количество
              <input id="tradeQty" type="number" step="0.0001" min="0" inputmode="decimal" />
            </label>
            <label>Цена
              <input id="tradePrice" type="number" step="0.0001" min="0" inputmode="decimal" />
            </label>
            <label>Комиссия
              <input id="tradeCommission" type="number" step="0.0001" min="0" value="0" inputmode="decimal" />
            </label>
          </div>
          <button id="saveTradeBtn" class="btn primary">Сохранить сделку</button>
        </article>
      </section>

      <section id="tab-lookup" class="tab-view">
        <article class="card">
          <h2>Поиск цены и динамики</h2>
          <div class="form-grid two">
            <label>Тип
              <select id="lookupAssetType">
                <option value="stock">Акции</option>
                <option value="metal">Металлы</option>
                <option value="fiat">Фиат</option>
              </select>
            </label>
            <label>Поиск
              <div class="search-control">
                <button id="lookupSearchClear" class="search-clear" type="button" aria-label="Очистить поиск">×</button>
                <input id="lookupSearch" type="text" placeholder="Тикер или название" />
              </div>
            </label>
          </div>
          <div id="lookupSearchResults" class="list compact"></div>
          <p id="lookupSelected" class="hint">Инструмент не выбран</p>
          <button id="lookupBtn" class="btn primary">Показать динамику</button>
          <div id="lookupResult" class="lookup-result"></div>
        </article>
      </section>

      <section id="tab-movers" class="tab-view">
        <article class="card">
          <h2>Топ роста/падения</h2>
          <div class="chips">
            <button class="chip active" data-day="0">Сегодня</button>
            <button class="chip" data-day="1">Вчера</button>
            <button class="chip" data-day="2">Позавчера</button>
          </div>
          <p id="moversDate" class="hint"></p>
          <div class="split-list">
            <div>
              <h3>Рост</h3>
              <div id="moversTop" class="list compact"></div>
            </div>
            <div>
              <h3>Падение</h3>
              <div id="moversBottom" class="list compact"></div>
            </div>
          </div>
        </article>
      </section>

      <section id="tab-alerts" class="tab-view">
        <article class="card">
          <h2>Ценовые алерты</h2>
          <div class="form-grid two">
            <label>Тип
              <select id="alertAssetType">
                <option value="stock">Акции</option>
                <option value="metal">Металлы</option>
                <option value="fiat">Фиат</option>
              </select>
            </label>
            <label>Поиск
              <div class="search-control">
                <button id="alertSearchClear" class="search-clear" type="button" aria-label="Очистить поиск">×</button>
                <input id="alertSearch" type="text" placeholder="Тикер или название" />
              </div>
            </label>
          </div>
          <div id="alertSearchResults" class="list compact"></div>
          <p id="alertSelected" class="hint">Инструмент не выбран</p>
          <p id="alertSelectedPrice" class="hint"></p>
          <div class="form-grid two">
            <label>Цена
              <input id="alertTargetPrice" type="number" step="0.0001" min="0" inputmode="decimal" />
            </label>
            <label>Диапазон ±%
              <input id="alertRange" type="number" step="0.1" min="0" max="50" value="" placeholder="Необязательно" inputmode="decimal" />
            </label>
          </div>
          <button id="addAlertBtn" class="btn primary">Добавить алерт</button>
        </article>
        <article class="card">
          <h2>Активные алерты</h2>
          <div id="alerts" class="list"></div>
        </article>
      </section>

      <section id="tab-more" class="tab-view">
        <article class="card">
          <h2>USD/RUB</h2>
          <div class="row-between">
            <strong id="usdRubRate">—</strong>
            <button id="usdRubBtn" class="btn ghost">Обновить</button>
          </div>
          <p id="usdRubAsOf" class="hint"></p>
        </article>

        <article class="card">
          <h2>Отчеты дня</h2>
          <div class="toggle-row">
            <span>4 уведомления (открытие/середина/основная/вечерняя)</span>
            <label class="switch">
              <input id="openCloseToggle" type="checkbox" />
              <span class="slider"></span>
            </label>
          </div>
        </article>

        <article class="card">
          <h2>Импорт XML</h2>
          <form id="xmlForm" class="upload-form">
            <input id="xmlFile" type="file" accept=".xml,text/xml,application/xml" />
            <button class="btn primary" type="submit">Импортировать</button>
          </form>
          <pre id="xmlResult" class="plain"></pre>
        </article>

        <article class="card">
          <h2>Почему инвестировать</h2>
          <div id="articles" class="list compact"></div>
          <div id="articleText" class="plain"></div>
        </article>

        <article class="card danger-zone">
          <h2>Очистка портфеля</h2>
          <p class="hint">Удалит все сделки и позиции. Необратимо.</p>
          <button id="clearPortfolioBtn" class="btn danger">Очистить портфель</button>
        </article>
      </section>

      <section id="tab-budget" class="tab-view">
        <article id="budgetWelcomeCard" class="card">
          <h2>Давайте соберём ваш бюджет</h2>
          <p class="hint">Это займёт 5–10 минут. Вы увидите, сколько у вас <strong>свободно в месяц</strong> и что делать для целей.</p>
          <div class="mode-grid">
            <div class="mode-card">
              <h3>Быстро (5 минут)</h3>
              <p class="hint">Одна сумма расходов + обязательные платежи</p>
              <button id="startQuickOnboardingBtn" class="btn primary">Начать быстро</button>
            </div>
            <div class="mode-card">
              <h3>Точно (10 минут)</h3>
              <p class="hint">Чуть больше деталей → точнее прогноз</p>
              <button id="startPreciseOnboardingBtn" class="btn primary">Начать точно</button>
            </div>
          </div>
          <p class="hint">Мы не просим доступ к банку. Всё вводится вручную и можно изменить в любой момент.</p>
        </article>

        <article id="budgetWizardCard" class="card" style="display:none">
          <h2 id="budgetWizardTitle">Онбординг бюджета</h2>
          <p id="budgetStepProgress" class="hint">Шаг 1 из 5</p>
          <p id="budgetWizardSubtitle" class="hint"></p>
          <div id="budgetWizardBody"></div>
          <div class="wizard-actions">
            <button id="budgetBackBtn" class="btn ghost">Назад</button>
            <button id="budgetSkipBtn" class="btn ghost">Пропустить</button>
            <button id="budgetNextBtn" class="btn primary">Дальше</button>
          </div>
        </article>

        <article id="budgetResultCard" class="card" style="display:none">
          <h2>Ваш бюджет на месяц</h2>
          <div id="budgetResultBody" class="plain"></div>
          <div id="budgetResultActions" class="chips"></div>
        </article>

        <article id="budgetDashboardCard" class="card" style="display:none">
          <h2>Обзор бюджета</h2>
          <div class="overview-mix">
            <div id="budgetOverviewDonut" class="overview-donut" aria-label="Структура бюджета"></div>
            <div id="budgetOverviewShare" class="list compact overview-share"></div>
          </div>
          <div id="budgetCurrentMonth" class="plain"></div>
          <div class="overview-goals">
            <h3>Цели и прогресс</h3>
            <div id="budgetGoalsOverview" class="list compact"></div>
          </div>
          <button id="editBudgetBtn" class="btn ghost">Настроить бюджет</button>
        </article>

        <article id="budgetIncomeCard" class="card" style="display:none">
          <h2>Доходы</h2>
          <div class="form-grid three">
            <label>Тип дохода
              <select id="budgetIncomeTypeInput">
                <option value="salary">Зарплата</option>
                <option value="freelance">Фриланс</option>
                <option value="business">Бизнес</option>
                <option value="rent">Аренда</option>
                <option value="passive">Пассивный</option>
                <option value="other">Другое</option>
              </select>
            </label>
            <label>Название
              <input id="budgetIncomeTitleInput" type="text" placeholder="Например: Зарплата" />
            </label>
            <label>Сумма ежемесячного дохода, ₽
              <input id="budgetIncomeInput" type="text" placeholder="Например: 150000" />
            </label>
          </div>
          <button id="budgetIncomeSaveBtn" class="btn primary">Добавить</button>
          <div id="budgetIncomeList" class="list"></div>
        </article>

        <article id="budgetExpensesCard" class="card" style="display:none">
          <h2>Расходы</h2>
          <div class="form-grid two">
            <label>Тип расхода
              <select id="budgetExpenseTypeInput">
                <option value="rent">Аренда</option>
                <option value="mortgage">Ипотека</option>
                <option value="loan">Кредит</option>
                <option value="utilities">ЖКХ</option>
                <option value="other">Прочие расходы</option>
              </select>
            </label>
            <label>Название
              <input id="budgetExpenseTitleInput" type="text" placeholder="Например: аренда квартиры" />
            </label>
          </div>
          <div id="expenseFieldsRent" class="form-grid two">
            <label>Дата платежа
              <input id="expenseRentDateInput" type="date" />
            </label>
            <label>Сумма платежа, ₽
              <input id="expenseRentAmountInput" type="text" placeholder="Например: 45000" />
            </label>
          </div>
          <div id="expenseFieldsMortgage" class="form-grid three" style="display:none">
            <label>Дата начала ипотеки
              <input id="expenseMortgageStartInput" type="date" />
            </label>
            <label>Дата окончания (авто)
              <input id="expenseMortgageEndInput" type="date" readonly />
            </label>
            <label>Общая сумма задолженности, ₽
              <input id="expenseMortgagePrincipalInput" type="text" placeholder="Например: 3500000" />
            </label>
            <label>Срок, месяцев
              <input id="expenseMortgageMonthsInput" type="number" min="1" step="1" placeholder="Например: 240" />
            </label>
            <label>Тип платежа
              <select id="expenseMortgagePaymentTypeInput">
                <option value="annuity">Аннуитетный</option>
                <option value="diff">Дифференцированный</option>
              </select>
            </label>
          </div>
          <div id="expenseFieldsLoan" class="form-grid three" style="display:none">
            <label>Дата начала кредита
              <input id="expenseLoanStartInput" type="date" />
            </label>
            <label>Дата окончания (авто)
              <input id="expenseLoanEndInput" type="date" readonly />
            </label>
            <label>Сумма кредита, ₽
              <input id="expenseLoanPrincipalInput" type="text" placeholder="Например: 500000" />
            </label>
            <label>Срок, месяцев
              <input id="expenseLoanMonthsInput" type="number" min="1" step="1" placeholder="Например: 36" />
            </label>
            <label>Тип платежа
              <select id="expenseLoanPaymentTypeInput">
                <option value="annuity">Аннуитетный</option>
                <option value="diff">Дифференцированный</option>
              </select>
            </label>
          </div>
          <div id="expenseFieldsUtilities" class="form-grid two" style="display:none">
            <label>Дата оплаты
              <input id="expenseUtilitiesDateInput" type="date" />
            </label>
            <label>Сумма платежа, ₽
              <input id="expenseUtilitiesAmountInput" type="text" placeholder="Например: 8500" />
            </label>
          </div>
          <div id="expenseFieldsOther" class="form-grid one" style="display:none">
            <label>Сумма расходов, ₽
              <input id="expenseOtherAmountInput" type="text" placeholder="Например: 12000" />
            </label>
          </div>
          <div id="expenseRatePeriodsCard" class="card-inline" style="display:none">
            <h3>Ставки и периоды</h3>
            <div id="expenseRatePeriodsList" class="form-grid"></div>
            <button id="expenseAddRateBtn" class="btn ghost">Добавить ставку</button>
          </div>
          <div class="wizard-actions">
            <button id="budgetExpensesSaveBtn" class="btn primary">Добавить</button>
            <button id="budgetExpensesCancelEditBtn" class="btn ghost" style="display:none">Отмена редактирования</button>
          </div>
          <div id="budgetExpensesCalcResult" class="plain"></div>
          <div id="budgetExpensesList" class="list"></div>
        </article>

        <article id="budgetFundsCard" class="card" style="display:none">
          <h2>Цели</h2>
          <button id="addGoalBtn" class="btn primary">Добавить цель</button>
          <div id="budgetFundsList" class="list"></div>
        </article>

        <article id="goalDetailCard" class="card" style="display:none">
          <h2>Цель</h2>
          <div class="form-grid two">
            <label>Наименование цели
              <input id="goalTitleInput" type="text" placeholder="Например: отпуск" />
            </label>
            <label>Дата достижения
              <input id="goalTargetDateInput" type="date" />
            </label>
          </div>
          <label>Описание цели
            <textarea id="goalDescriptionInput" rows="3" placeholder="Например: отпуск с семьёй в августе"></textarea>
          </label>
          <div class="form-grid two">
            <label>Сумма цели, ₽
              <input id="goalTargetAmountInput" type="text" placeholder="Например: 500000" />
            </label>
            <label>Отложено на цель, ₽
              <input id="goalTopupAmountInput" type="text" placeholder="Например: 10000" />
            </label>
          </div>
          <div class="wizard-actions">
            <button id="goalTopupBtn" class="btn ghost">Добавить сумму</button>
            <button id="goalSaveBtn" class="btn primary">Сохранить редактирование цели</button>
            <button id="goalDeleteBtn" class="btn danger">Удалить цель</button>
            <button id="goalCancelBtn" class="btn ghost">Закрыть</button>
          </div>
          <div id="goalProgressText" class="plain"></div>
          <div class="progress-line"><div id="goalProgressFill" class="progress-fill" style="width:0%"></div></div>
          <h3>Чекбоксы цели</h3>
          <div id="goalChecklistList" class="plain"></div>
          <div class="form-grid two">
            <label>Новый чекбокс
              <input id="goalChecklistInput" type="text" placeholder="Например: купить билеты" />
            </label>
            <label>Шаблоны
              <select id="goalChecklistTemplateSelect">
                <option value="">Выберите шаблон</option>
                <option value="Найти новую работу">Найти новую работу</option>
                <option value="Съездить в отпуск">Съездить в отпуск</option>
                <option value="Купить вещи">Купить вещи</option>
                <option value="Купить билеты">Купить билеты</option>
              </select>
            </label>
          </div>
          <button id="goalChecklistAddBtn" class="btn ghost">Добавить чекбокс</button>
        </article>

        <article id="budgetMonthCloseCard" class="card" style="display:none">
          <h2>Закрыть прошлый месяц</h2>
          <p class="hint">Добавьте фактические траты и доп. доходы — прогноз целей станет точнее.</p>
          <button id="closeMonthOpenBtn" class="btn primary">Закрыть месяц</button>
          <div id="monthCloseForm" style="display:none">
            <div class="form-grid two">
              <label>Факт расходов, ₽
                <input id="monthCloseActualInput" type="text" placeholder="Например: 105000" />
              </label>
              <label>Доп. доходы, ₽
                <input id="monthCloseExtraInput" type="text" placeholder="Например: 5000" />
              </label>
            </div>
            <div class="wizard-actions">
              <button id="monthCloseSubmitBtn" class="btn primary">Закрыть сейчас</button>
              <button id="monthCloseCancelBtn" class="btn ghost">Отмена</button>
            </div>
          </div>
          <div id="monthCloseBody" class="plain" style="display:none"></div>
        </article>

        <article id="budgetLoanCalcCard" class="card" style="display:none">
          <h2>Кредит / Ипотека</h2>
          <p class="hint">Расчёт ежемесячного платежа, переплаты и итоговой суммы.</p>
          <div class="form-grid three">
            <label>Сумма кредита, ₽
              <input id="loanAmountInput" type="text" placeholder="Например: 3500000" />
            </label>
            <label>Ставка, % годовых
              <input id="loanRateInput" type="number" step="0.01" min="0" placeholder="Например: 14.9" />
            </label>
            <label>Срок, месяцев
              <input id="loanMonthsInput" type="number" step="1" min="1" placeholder="Например: 180" />
            </label>
          </div>
          <label>Тип платежа
            <select id="loanTypeInput">
              <option value="annuity">Аннуитетный</option>
              <option value="diff">Дифференцированный</option>
            </select>
          </label>
          <div class="wizard-actions">
            <button id="loanCalcBtn" class="btn primary">Рассчитать</button>
          </div>
          <div id="loanCalcResult" class="plain"></div>
        </article>

        <article id="budgetSettingsCard" class="card" style="display:none">
          <h2>Настройки</h2>
          <h3>Уведомления</h3>
          <div class="toggle-row">
            <span>Сводка бюджета</span>
            <label class="switch">
              <input id="budgetNotifSummaryToggle" type="checkbox" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <span>Напоминания по целям</span>
            <label class="switch">
              <input id="budgetNotifGoalsToggle" type="checkbox" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-row">
            <span>Напоминание закрыть месяц</span>
            <label class="switch">
              <input id="budgetNotifMonthCloseToggle" type="checkbox" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="wizard-actions">
            <button id="budgetNotifSaveBtn" class="btn primary">Сохранить настройки</button>
          </div>
          <h3>Данные бюджета</h3>
          <button id="budgetResetBtn" class="btn danger">Удалить бюджет</button>
          <p class="hint">Удалит все данные бюджета, включая цели и историю.</p>
        </article>
      </section>
    </main>

    <nav class="tabbar" id="tabbarExchange">
      <button class="tab-btn active" data-tab="mode">Режим</button>
      <button class="tab-btn" data-tab="dashboard">Портфель</button>
      <button class="tab-btn" data-tab="trade">Сделка</button>
      <button class="tab-btn" data-tab="lookup">Поиск</button>
      <button class="tab-btn" data-tab="movers">Рынок</button>
      <button class="tab-btn" data-tab="alerts">Алерты</button>
      <button class="tab-btn" data-tab="more">Ещё</button>
    </nav>
    <nav class="tabbar hidden" id="tabbarBudget">
      <button class="tab-btn active" data-tab="mode">Режим</button>
      <button class="tab-btn" data-budget-tab="overview">Обзор</button>
      <button class="tab-btn" data-budget-tab="income">Доходы</button>
      <button class="tab-btn" data-budget-tab="expenses">Расходы</button>
      <button class="tab-btn" data-budget-tab="funds">Цели</button>
      <button class="tab-btn" data-budget-tab="loans">Кредиты</button>
      <button class="tab-btn" data-budget-tab="close">Закрытие</button>
      <button class="tab-btn" data-budget-tab="settings">Настройки</button>
    </nav>
  </div>

  <div id="globalLoader" class="global-loader" aria-live="polite" aria-hidden="true">
    <div class="global-loader-card" role="status" aria-label="Загрузка">
      <span class="global-loader-spinner" aria-hidden="true"></span>
      <span id="globalLoaderText">Загрузка…</span>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <script src="/miniapp/app.js"></script>
</body>
</html>
