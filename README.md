# MOEX Portfolio Bot

Telegram-бот для учета сделок, оценки портфеля и мониторинга рынка MOEX.

## Что умеет бот

### Кратко (по командам)

| Команда | Краткое описание |
|---|---|
| `/start` | Показать приветствие, меню и список команд |
| `/add_trade` | Добавить сделку (покупка/продажа) по акции или металлу |
| `/portfolio` | Показать текущую стоимость портфеля и P&L |
| `/portfolio_map` | Показать выбор: «Карта для себя» или «Поделиться картой портфеля» |
| `/asset_lookup` | Найти инструмент и показать цену + динамику за периоды |
| `/top_movers` | Показать кнопки дат (текущая/вчера/позавчера) и топ роста/падения |
| `/usd_rub` | Показать текущий курс USD/RUB с MOEX |
| `/alert` | Поставить ценовой алерт по акции/металлу/фиату |
| `/alerts_list` | Показать активные ценовые алерты и отключить выбранный |
| `/clear_portfolio` | Очистить портфель (удалить сделки) с подтверждением |
| `/import_broker_xml` | Импортировать сделки из XML брокерского отчета |
| `/set_interval <мин>` | Включить периодические отчеты |
| `/interval_off` | Выключить периодические отчеты |
| `/set_drop_alert <процент>` | Включить алерт падения цены от средней |
| `/drop_alert_off` | Выключить алерт падения |
| `/market_reports_on` | Включить отчеты торгового дня (4 точки по МСК) |
| `/market_reports_off` | Выключить отчеты торгового дня |
| `/alerts_status` | Показать статус всех уведомлений |
| `/why_invest` | Показать обучающие/информационные тексты |

## Расширенное описание функций

### 1) Старт и меню

#### `/start`
Кратко: показывает, что умеет бот, и выводит основные кнопки меню.

Расширенно:
- отправляет приветственный текст;
- показывает основные команды;
- активирует клавиатуру с быстрыми кнопками:
  - `Добавить сделку`
  - `Стоимость портфеля`
  - `Карта портфеля`
  - `Поиск цены`
  - `Настройки уведомлений`
  - `Зачем инвестировать`

### 2) Учет сделок и портфель

#### `/add_trade`
Кратко: пошагово добавляет сделку.

Расширенно:
- сценарий через FSM: дата -> покупка/продажа -> тип актива -> инструмент -> количество -> цена -> подтверждение;
- поддерживает акции и металлы;
- по продаже контролирует доступный остаток;
- после сохранения показывает обновленные параметры позиции (кол-во, средняя, вложено, текущая оценка).

#### `/portfolio`
Кратко: текущий срез портфеля и P&L.

Расширенно:
- считает стоимость по всем открытым позициям;
- показывает по каждой позиции:
  - тикер/название,
  - количество,
  - стоимость,
  - P&L;
- показывает итоговую стоимость и общий P&L;
- использует кэш котировок для снижения нагрузки;
- если часть цен недоступна, сообщает, сколько инструментов не вошло в итог.

#### `/portfolio_map`
Кратко: визуальная карта портфеля в PNG.

Расширенно:
- сначала показывает 2 кнопки:
  - `Карта для себя` — treemap по всем инструментам портфеля;
  - `Поделиться картой портфеля` — стильная share-карточка с метриками без раскрытия сумм;
- для share-карточки выводятся:
  - инструменты от большего к меньшему (в долях),
  - рост портфеля за 30 дней в процентах,
  - топ-3 выгодных и топ-3 убыточных инструментов по процентам,
  - сравнение доходности портфеля и индекса MOEX (IMOEX) за 30 дней.

#### `/clear_portfolio`
Кратко: полная очистка портфеля.

Расширенно:
- отправляет подтверждение с inline-кнопками;
- при подтверждении удаляет сделки пользователя и агрегированные позиции;
- сбрасывает состояние связанного мониторинга позиций.

### 3) Поиск инструментов и рынок

#### `/asset_lookup`
Кратко: поиск инструмента и его динамика.

Расширенно:
- выбирается тип инструмента (акции/металлы);
- поиск по тикеру/ISIN/названию;
- по выбранному инструменту показывает:
  - текущую цену,
  - динамику за неделю, месяц, 6 месяцев, год.

#### `/top_movers`
Кратко: топ роста/падения по TQBR за выбранную дату.

Расширенно:
- сначала показывает 3 кнопки даты:
  - текущая,
  - вчера,
  - позавчера;
- после выбора даты показывает:
  - топ-10 роста,
  - топ-5 падения,
  - цену открытия и итоговую цену дня/сессии,
  - оборот в рублях: `Объём торгов за день: ... RUB`.

### 4) Импорт данных

#### `/import_broker_xml`
Кратко: импорт сделок из XML-отчета брокера.

Расширенно:
- принимает XML-файл;
- парсит сделки и сопоставляет инструменты;
- защищает от дублей через `external_trade_id`;
- по итогам показывает:
  - сколько добавлено,
  - сколько дублей,
  - что не удалось сопоставить.

### 5) Уведомления

#### `/set_interval <мин>` и `/interval_off`
Кратко: включение/выключение периодических отчетов.

Расширенно:
- настраивается интервал в минутах;
- бот отправляет регулярный snapshot портфеля;
- можно выключить одной командой.

#### `/set_drop_alert <процент>` и `/drop_alert_off`
Кратко: алерт сильного падения от средней цены позиции.

Расширенно:
- порог задается в процентах;
- если цена падает ниже порога, бот отправляет предупреждение;
- повторные сообщения не дублируются, пока состояние не изменится.

#### `/alert`
Кратко: ценовой алерт по целевой цене инструмента.

Расширенно:
- сценарий: тип инструмента -> поиск -> выбор -> целевая цена -> подтверждение диапазона;
- поддерживает акции, металлы и фиат (валютные пары MOEX);
- по умолчанию доступен диапазон срабатывания `±5%` от целевой цены;
- антиспам: повторное уведомление не чаще 1 раза в 75 минут на один алерт;
- текст уведомления: `Цена инструмента {название} ({тикер}) достигла {сумма}`.

#### `/alerts_list`
Кратко: управление активными ценовыми алертами.

Расширенно:
- показывает список всех активных алертов пользователя в виде кнопок;
- по нажатию на алерт запрашивает подтверждение на отключение;
- после подтверждения отключает выбранный алерт.

#### `/market_reports_on` и `/market_reports_off`
Кратко: отчеты торгового дня в 4 точки по МСК.

Расширенно:
- в рабочие дни по МСК отправляет отчеты:
  - на открытии биржи,
  - в середине торгового дня,
  - на закрытии основной сессии,
  - на закрытии вечерней сессии;
- по умолчанию используются времена:
  - открытие `06:50`,
  - середина дня `14:30`,
  - закрытие основной сессии `18:50` (до `22.03.2026`) и `19:00` (с `23.03.2026`),
  - закрытие вечерней сессии `23:50`;
- при необходимости можно переопределить через env:
  - `TRADING_DAY_OPEN_HOUR`, `TRADING_DAY_OPEN_MINUTE`,
  - `TRADING_DAY_MIDDAY_HOUR`, `TRADING_DAY_MIDDAY_MINUTE`,
  - `TRADING_DAY_MAIN_CLOSE_HOUR`, `TRADING_DAY_MAIN_CLOSE_MINUTE`,
  - `TRADING_DAY_EVENING_CLOSE_HOUR`, `TRADING_DAY_EVENING_CLOSE_MINUTE`;
- защищено от повторной отправки в тот же день.

#### `/alerts_status`
Кратко: статус всех уведомлений.

Расширенно:
- показывает включен/выключен режим для каждого типа уведомлений;
- выводит текущие параметры (например, интервал или порог падения).

### 6) Контент

#### `/why_invest`
Кратко: вывод информационных материалов.

Расширенно:
- показывает список активных статей из БД;
- открывает выбранный текст по callback-кнопке;
- если список пуст, отдает fallback-текст.

## Источник котировок и fallback

Бот использует схему:
- основной источник: **ALGOPACK** (`ALGOPACK_API_KEY`),
- fallback: **бесплатный ISS MOEX**.

Если сработал fallback, в ответ добавляется пометка:
- `(данные с задержкой в 15 минут)`

## Быстрый запуск

1. Установить зависимости:
`pip install -r requirements.txt`

2. Задать переменные окружения:
- `BOT_TOKEN`
- `DATABASE_URL`
- `ALGOPACK_API_KEY` (рекомендуется)

3. Запустить:
`python main.py`

## Smoke-check перед деплоем

Быстрая проверка проекта из локального виртуального окружения:

`./.venv/bin/python scripts/smoke_check.py`

Опционально:
- с проверкой БД (нужен `DATABASE_URL`): `./.venv/bin/python scripts/smoke_check.py --with-db`
- с live-проверкой MOEX API: `./.venv/bin/python scripts/smoke_check.py --with-network`

## Технические модули

- `main.py` — Telegram-логика, команды, FSM, генерация карты портфеля, воркер уведомлений.
- `db.py` — инициализация и доступ к PostgreSQL, позиции и алерты.
- `moex_iss.py` — рыночные API MOEX/ALGOPACK, fallback, поиск, цены, история, movers, snapshot.
- `broker_report_xml.py` — парсинг XML брокерского отчета.
- `portfolio_cards.py` — рендер PNG-карт (карта портфеля и share-карточка).
