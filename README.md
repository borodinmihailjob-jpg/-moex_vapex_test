# MOEX Portfolio Bot

Telegram-бот для учета сделок, оценки портфеля, мониторинга рынка MOEX и базовой аналитики (ребалансировка, watchlist, digest).

## Что умеет бот

### Кратко (по командам)

| Команда | Краткое описание |
|---|---|
| `/start` | Показать приветствие, меню и список команд |
| `/add_trade` | Добавить сделку (покупка/продажа) по акции или металлу |
| `/portfolio` | Показать текущую стоимость портфеля и P&L |
| `/portfolio_map` | Сгенерировать карту портфеля (PNG) по акциям и металлам |
| `/asset_lookup` | Найти инструмент и показать цену + динамику за периоды |
| `/top_movers` | Показать кнопки дат (текущая/вчера/позавчера) и топ роста/падения |
| `/clear_portfolio` | Очистить портфель (удалить сделки) с подтверждением |
| `/import_broker_xml` | Импортировать сделки из XML брокерского отчета |
| `/set_interval <мин>` | Включить периодические отчеты |
| `/interval_off` | Выключить периодические отчеты |
| `/set_drop_alert <процент>` | Включить алерт падения цены от средней |
| `/drop_alert_off` | Выключить алерт падения |
| `/market_reports_on` | Включить отчеты на открытии/закрытии биржи |
| `/market_reports_off` | Выключить отчеты на открытии/закрытии |
| `/alerts_status` | Показать статус всех уведомлений |
| `/set_profile <type>` | Установить профиль ребалансировки (`conservative`, `balanced`, `aggressive`) |
| `/rebalance_plan` | Построить план ребалансировки (веса, отклонения, действия) |
| `/watchlist_add <TICKER>` | Добавить тикер в watchlist |
| `/watchlist_remove <TICKER>` | Удалить тикер из watchlist |
| `/watchlist` | Показать текущий watchlist |
| `/market_digest [mode]` | Сигналы по watchlist (`premarket`, `open`, `close`) |
| `/why_invest` | Показать обучающие/информационные тексты |

## Расширенное описание функций

### 1) Старт и меню

#### `/start`
Кратко: показывает, что умеет бот, и выводит основные кнопки меню.

Расширенно:
- отправляет приветственный текст;
- показывает основные команды;
- активирует клавиатуру с быстрыми кнопками:
  - `Добавить сделку`
  - `Стоимость портфеля`
  - `Карта портфеля`
  - `Поиск цены`
  - `Настройки уведомлений`
  - `Зачем инвестировать`

### 2) Учет сделок и портфель

#### `/add_trade`
Кратко: пошагово добавляет сделку.

Расширенно:
- сценарий через FSM: дата -> покупка/продажа -> тип актива -> инструмент -> количество -> цена -> подтверждение;
- поддерживает акции и металлы;
- по продаже контролирует доступный остаток;
- после сохранения показывает обновленные параметры позиции (кол-во, средняя, вложено, текущая оценка).

#### `/portfolio`
Кратко: текущий срез портфеля и P&L.

Расширенно:
- считает стоимость по всем открытым позициям;
- показывает по каждой позиции:
  - тикер/название,
  - количество,
  - стоимость,
  - P&L;
- показывает итоговую стоимость и общий P&L;
- использует кэш котировок для снижения нагрузки;
- если часть цен недоступна, сообщает, сколько инструментов не вошло в итог.

#### `/portfolio_map`
Кратко: визуальная карта портфеля в PNG.

Расширенно:
- строит treemap по всем инструментам портфеля (акции + металлы);
- размер плитки = доля позиции в общей стоимости;
- цвет = результат по позиции (зелёный/красный);
- очень маленькие позиции отображаются цветными плитками без подписей;
- отправляется как документ PNG (без сжатия Telegram) для лучшего качества.

#### `/clear_portfolio`
Кратко: полная очистка портфеля.

Расширенно:
- отправляет подтверждение с inline-кнопками;
- при подтверждении удаляет сделки пользователя и агрегированные позиции;
- сбрасывает состояние связанного мониторинга позиций.

### 3) Поиск инструментов и рынок

#### `/asset_lookup`
Кратко: поиск инструмента и его динамика.

Расширенно:
- выбирается тип инструмента (акции/металлы);
- поиск по тикеру/ISIN/названию;
- по выбранному инструменту показывает:
  - текущую цену,
  - динамику за неделю, месяц, 6 месяцев, год.

#### `/top_movers`
Кратко: топ роста/падения по TQBR за выбранную дату.

Расширенно:
- сначала показывает 3 кнопки даты:
  - текущая,
  - вчера,
  - позавчера;
- после выбора даты показывает:
  - топ-10 роста,
  - топ-5 падения,
  - цену открытия и итоговую цену дня/сессии,
  - оборот в рублях: `Объём торгов за день: ... RUB`.

### 4) Импорт данных

#### `/import_broker_xml`
Кратко: импорт сделок из XML-отчета брокера.

Расширенно:
- принимает XML-файл;
- парсит сделки и сопоставляет инструменты;
- защищает от дублей через `external_trade_id`;
- по итогам показывает:
  - сколько добавлено,
  - сколько дублей,
  - что не удалось сопоставить.

### 5) Уведомления

#### `/set_interval <мин>` и `/interval_off`
Кратко: включение/выключение периодических отчетов.

Расширенно:
- настраивается интервал в минутах;
- бот отправляет регулярный snapshot портфеля;
- можно выключить одной командой.

#### `/set_drop_alert <процент>` и `/drop_alert_off`
Кратко: алерт сильного падения от средней цены позиции.

Расширенно:
- порог задается в процентах;
- если цена падает ниже порога, бот отправляет предупреждение;
- повторные сообщения не дублируются, пока состояние не изменится.

#### `/market_reports_on` и `/market_reports_off`
Кратко: отчеты на открытии и закрытии MOEX.

Расширенно:
- в рабочие дни по МСК отправляет отчет на событиях открытия/закрытия;
- защищено от повторной отправки в тот же день.

#### `/alerts_status`
Кратко: статус всех уведомлений.

Расширенно:
- показывает включен/выключен режим для каждого типа уведомлений;
- выводит текущие параметры (например, интервал или порог падения).

### 6) MVP: ребалансировка

#### `/set_profile <conservative|balanced|aggressive>`
Кратко: выбор риск-профиля для ребалансировки.

Расширенно:
- сохраняет профиль пользователя в БД;
- профиль определяет целевые доли акций и металлов.

#### `/rebalance_plan`
Кратко: план действий по ребалансу.

Расширенно:
- рассчитывает текущие доли акций и металлов;
- сравнивает с целями выбранного профиля;
- показывает отклонение;
- формирует действия:
  - `докупить` или
  - `сократить`
  с оценкой суммы в RUB;
- использует порог чувствительности (чтобы не реагировать на мелкий шум).

### 7) MVP: watchlist и сигналы рынка

#### `/watchlist_add <TICKER>`
Кратко: добавляет инструмент в персональный watchlist.

Расширенно:
- сохраняет тикер в БД;
- используется в digest-команде для сигналов.

#### `/watchlist_remove <TICKER>`
Кратко: удаляет инструмент из watchlist.

Расширенно:
- удаляет запись из БД;
- сообщает, был ли инструмент найден.

#### `/watchlist`
Кратко: показывает список наблюдаемых инструментов.

Расширенно:
- выводит тикеры и board;
- используется как базовый источник для digest.

#### `/market_digest [premarket|open|close]`
Кратко: сводка сигналов по watchlist.

Расширенно:
- собирает snapshot по каждому тикеру из watchlist;
- формирует блоки:
  - лидеры по секторам,
  - аномальные объемы (сравнение с 20-дневным средним),
  - расширение спреда bid/offer;
- поддерживает режимы `premarket`, `open`, `close` (MVP-режимы запроса).

### 8) Контент

#### `/why_invest`
Кратко: вывод информационных материалов.

Расширенно:
- показывает список активных статей из БД;
- открывает выбранный текст по callback-кнопке;
- если список пуст, отдает fallback-текст.

## Источник котировок и fallback

Бот использует схему:
- основной источник: **ALGOPACK** (`ALGOPACK_API_KEY`),
- fallback: **бесплатный ISS MOEX**.

Если сработал fallback, в ответ добавляется пометка:
- `(данные с задержкой в 15 минут)`

## Обязательный дисклеймер

Для новых аналитических MVP-функций (ребалансировка, watchlist, digest) бот добавляет дисклеймер:

> Данная информация не является индивидуальной инвестиционной рекомендацией, и финансовые инструменты либо операции, упомянутые в ней, могут не соответствовать Вашему инвестиционному профилю и инвестиционным целям (ожиданиям). Определение соответствия финансового инструмента либо операции Вашим интересам, инвестиционным целям, инвестиционному горизонту и уровню допустимого риска является Вашей задачей.

## Быстрый запуск

1. Установить зависимости:
`pip install -r requirements.txt`

2. Задать переменные окружения:
- `BOT_TOKEN`
- `DATABASE_URL`
- `ALGOPACK_API_KEY` (рекомендуется)

3. Запустить:
`python main.py`

## Технические модули

- `main.py` — Telegram-логика, команды, FSM, генерация карты портфеля, воркер уведомлений.
- `db.py` — инициализация и доступ к PostgreSQL, позиции, алерты, watchlist, профили.
- `moex_iss.py` — рыночные API MOEX/ALGOPACK, fallback, поиск, цены, история, movers, snapshot.
- `broker_report_xml.py` — парсинг XML брокерского отчета.
